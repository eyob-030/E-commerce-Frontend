<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Commerce Store</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .card-img-top {
        height: 200px;
        object-fit: contain;
        padding: 10px;
      }
      .card {
        transition: transform 0.3s;
      }
      .card:hover {
        transform: translateY(-5px);
      }
      .search-bar {
        width: 100%;
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .search-button {
        background: none;
        border: none;
        cursor: pointer;
      }
      .section-title {
        font-weight: 700;
        font-size: 2rem;
      }
    </style>
  </head>
  <body>
    <!-- Shop Section -->
    <section class="py-5" id="shop">
      <div class="container">
        <h2 class="section-title text-center">
          Trending <span class="text-warning text-center">Collection</span>
        </h2>
        <br />
        <div class="amazon-header-middle-section d-flex">
          <input class="search-bar" type="text" placeholder="Search" />
          <button class="search-button">
            <i class="fas fa-search"></i>
          </button>
        </div>
        <br /><br />
        <div
          class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4"
          id="productGrid"
        >
          <!-- Products will be dynamically inserted here by JavaScript -->
        </div>
      </div>
    </section>

    <script>
      // Cart functions
      const CART_KEY = "shopping_cart";

      function getCart() {
        const cart = localStorage.getItem(CART_KEY);
        return cart ? JSON.parse(cart) : {};
      }

      function updateCart(productId, quantity) {
        const cart = getCart();

        if (quantity > 0) {
          cart[productId] = (cart[productId] || 0) + parseInt(quantity);
        } else {
          delete cart[productId];
        }

        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        updateCartCounter();
        return cart;
      }

      function updateCartCounter() {
        const cart = getCart();
        const totalItems = Object.values(cart).reduce(
          (sum, qty) => sum + qty,
          0
        );
        const cartQuantityElement = document.querySelector(".cart-quantity");
        if (cartQuantityElement) {
          cartQuantityElement.textContent = totalItems;
          cartQuantityElement.style.display = totalItems > 0 ? "block" : "none";
        }
      }

      function addToCart(productId, quantity) {
        if (isNaN(quantity)) {
          console.error("Invalid quantity");
          return;
        }

        const qty = parseInt(quantity);
        if (qty < 1) {
          alert("Please enter a valid quantity");
          return;
        }

        updateCart(productId, qty);

        // Show feedback to user
        const feedback = document.createElement("div");
        feedback.className =
          "alert alert-success position-fixed top-0 end-0 m-3";
        feedback.style.zIndex = "1000";
        feedback.textContent = `Added ${qty} item(s) to cart!`;
        document.body.appendChild(feedback);

        setTimeout(() => {
          feedback.style.opacity = "0";
          setTimeout(() => feedback.remove(), 300);
        }, 2000);
      }

      function getStarIcons(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5 ? 1 : 0;
        const emptyStars = 5 - fullStars - halfStar;

        return (
          "★".repeat(fullStars) + (halfStar ? "½" : "") + "☆".repeat(emptyStars)
        );
      }

      async function loadProducts() {
        try {
          const productGrid = document.getElementById("productGrid");
          productGrid.innerHTML =
            '<div class="col-12 text-center"><div class="spinner-border text-warning" role="status"></div></div>';

          const response = await fetch("http://localhost:5000/api/products");
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const products = await response.json();
          productGrid.innerHTML = "";

          if (!products || products.length === 0) {
            productGrid.innerHTML =
              '<div class="col-12 text-center"><p>No products found</p></div>';
            return;
          }

          const cart = getCart();

          products.forEach((product, index) => {
            const productId = product.id || index;
            const inCartQty = cart[productId] || 0;

            const productHTML = `
              <div class="col">
                <div class="card h-100">
                  <img src="${
                    product.image_url || "https://via.placeholder.com/300"
                  }" class="card-img-top" alt="${product.name}" loading="lazy">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text">${product.description}</p>
                    <p class="card-text mt-auto">
                      $${parseFloat(product.price).toFixed(2)}
                    </p>
                    <div class="d-flex align-items-center gap-2 mb-3">
                      <label for="qty${productId}" class="form-label mb-0">Qty:</label>
                      <input type="number" class="form-control form-control-sm quantity-input" 
                            id="qty${productId}" min="1" value="1" style="width: 60px;">
                      ${
                        inCartQty > 0
                          ? `<span class="badge bg-success ms-2">${inCartQty} in cart</span>`
                          : ""
                      }
                    </div>
                    <button class="btn btn-warning w-100 add-to-cart" data-product-id="${productId}">
                      <i class="fas fa-shopping-cart me-2"></i>
                      ${inCartQty > 0 ? "Add More" : "Add to Cart"}
                    </button>
                  </div>
                </div>
              </div>
            `;

            productGrid.insertAdjacentHTML("beforeend", productHTML);
          });

          // Add event listeners
          document.querySelectorAll(".add-to-cart").forEach((button) => {
            button.addEventListener("click", function () {
              const productId = this.getAttribute("data-product-id");
              const quantityInput = document.getElementById(`qty${productId}`);
              const quantity = quantityInput.value;
              addToCart(productId, quantity);

              // Update UI
              const cart = getCart();
              const inCartQty = cart[productId] || 0;
              this.innerHTML = `<i class="fas fa-shopping-cart me-2"></i>${
                inCartQty > 0 ? "Add More" : "Add to Cart"
              }`;

              // Update badge
              const badgeContainer = quantityInput.parentNode;
              let badge = badgeContainer.querySelector(".badge.bg-success");
              if (inCartQty > 0) {
                if (!badge) {
                  badge = document.createElement("span");
                  badge.className = "badge bg-success ms-2";
                  badgeContainer.appendChild(badge);
                }
                badge.textContent = `${inCartQty} in cart`;
              } else if (badge) {
                badge.remove();
              }
            });
          });

          updateCartCounter();
        } catch (error) {
          console.error("Failed to load products:", error);
          productGrid.innerHTML = `
            <div class="col-12 text-center">
              <p class="text-danger">Failed to load products. Please try again later.</p>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      // Initialize when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        loadProducts();

        // Search functionality
        const searchButton = document.querySelector(".search-button");
        const searchInput = document.querySelector(".search-bar");

        if (searchButton && searchInput) {
          searchButton.addEventListener("click", function () {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
              console.log("Searching for:", searchTerm);
              // Implement search filtering here
            }
          });

          searchInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              searchButton.click();
            }
          });
        }
      });
    </script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
